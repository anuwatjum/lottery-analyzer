import streamlit as st
import pandas as pd
from collections import Counter

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
st.set_page_config(page_title="Supersootr Analyzer V2", page_icon="üìä")

# ==========================================
# 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö (Raw Data)
# ==========================================
# (‡∏ú‡∏°‡∏¢‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÅ‡∏ï‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ä‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
raw_data = [
    ("2024-01-02", "02956243934493853"),
("2024-01-03", "03985835586526276"),
("2024-01-04", "05896689450125997"),
("2024-01-05", "02768243580799663"),
("2024-01-08", "07125544233634551"),
("2024-01-09", "04297894424799352"),
("2024-01-10", "02271147959665241"),
("2024-01-11", "00957589402502428"),
("2024-01-12", "05834593585615329"),
("2024-01-15", "09946742146070251"),
("2024-01-16", "07230267630727230"),
("2024-01-17", "03537462686866507"),
("2024-01-18", "05388054073929372"),
("2024-01-19", "07077465332395158"),
("2024-01-22", "04605193279729259"),
("2024-01-23", "09604375530385438"),
("2024-01-24", "07777337991371965"),
("2024-01-25", "07940704956630910"),
("2024-01-26", "08524070266431594"),
("2024-01-29", "00186968195802813"),
("2024-01-30", "00820835592641414"),
("2024-01-31", "02886516322925262"),
("2024-02-01", "04111924089379644"),
("2024-02-02", "03539727633370812"),
("2024-02-05", "00305362805979315"),
("2024-02-06", "04653263346539603"),
("2024-02-07", "06266111520240206"),
("2024-02-08", "07032435995076042"),
("2024-02-09", "02262589805453723"),
("2024-02-12", "05681248702653093"),
("2024-02-13", "07848471708787343"),
("2024-02-14", "02053066734391162"),
("2024-02-15", "09382059480692716"),
("2024-02-16", "00477371074532700"),
("2024-02-19", "05473704307803306"),
("2024-02-20", "07558221117160726"),
("2024-02-21", "06053787192856154"),
("2024-02-22", "05493650438774786"),
("2024-02-23", "00861222546011433"),
("2024-02-27", "03218793595197044"),
("2024-02-28", "06307383211590565"),
("2024-02-29", "06144149187186738"),
("2024-03-01", "07811759262054225"),
("2024-03-04", "00159864499575983"),
("2024-03-05", "09168392019402633"),
("2024-03-06", "09531239715895529"),
("2024-03-07", "03277287367881661"),
("2024-03-08", "02307887220044226"),
("2024-03-11", "00537499392502319"),
("2024-03-12", "04017616265586360"),
("2024-03-13", "03673599663005188"),
("2024-03-14", "04998257409589342"),
("2024-03-15", "02073633087060489"),
("2024-03-18", "00905575319159410"),
("2024-03-19", "07177828855614648"),
("2024-03-20", "01266786882641828"),
("2024-03-21", "00082553707896244"),
("2024-03-22", "07008075518440458"),
("2024-03-25", "02622248092124955"),
("2024-03-26", "05102237440912374"),
("2024-03-27", "01310098680578360"),
("2024-03-28", "08097107350333449"),
("2024-03-29", "07844855142089460"),
("2024-04-01", "03541041033394854"),
("2024-04-02", "00147163238104602"),
("2024-04-03", "07175262005416977"),
("2024-04-04", "08819769368018980"),
("2024-04-05", "06326213251625869"),
("2024-04-09", "06709660833751153"),
("2024-04-10", "09988716095841706"),
("2024-04-11", "00611467116013879"),
("2024-04-17", "08850043449899444"),
("2024-04-18", "06874778340460292"),
("2024-04-19", "06834930941610894"),
("2024-04-22", "00294100271635244"),
("2024-04-23", "07624095762104694"),
("2024-04-24", "08034904486401064"),
("2024-04-25", "08327827249392717"),
("2024-04-26", "04215022549789433"),
("2024-04-29", "09096544026689703"),
("2024-04-30", "08790353882859598"),
("2024-05-02", "06431950052572570"),
("2024-05-03", "08863542933089267"),
("2024-05-07", "01220657341493745"),
("2024-05-08", "08952471085483304"),
("2024-05-09", "00875885570372904"),
("2024-05-10", "06233092062679061"),
("2024-05-13", "07020989258325060"),
("2024-05-14", "08232419185355707"),
("2024-05-15", "02730154226314413"),
("2024-05-16", "02177439976327228"),
("2024-05-17", "06189336121496896"),
("2024-05-20", "03466255730627098"),
("2024-05-21", "05218076345258387"),
("2024-05-23", "09916473675088499"),
("2024-05-24", "01470998553314836"),
("2024-05-27", "01567470148003789"),
("2024-05-28", "09760013615227067"),
("2024-05-29", "08919313998728387"),
("2024-05-30", "07310820109745269"),
("2024-05-31", "00856836950026686"),
("2024-06-04", "02559036326403234"),
("2024-06-05", "00977825018863200"),
("2024-06-06", "02997735969634191"),
("2024-06-07", "08241672680397433"),
("2024-06-10", "08193660877975717"),
("2024-06-11", "08869560163061047"),
("2024-06-12", "00109733703936959"),
("2024-06-13", "03768353465047891"),
("2024-06-14", "06117562209695622"),
("2024-06-17", "03224926436205997"),
("2024-06-18", "09940610201424182"),
("2024-06-19", "09756924970718241"),
("2024-06-20", "08696196383992953"),
("2024-06-21", "09138593020914112"),
("2024-06-24", "06279086743027332"),
("2024-06-25", "06390740147741441"),
("2024-06-26", "00692674781331501"),
("2024-06-27", "03976922397184669"),
("2024-06-28", "06977182821259650"),
("2024-07-01", "02125910546503561"),
("2024-07-02", "04392647148875877"),
("2024-07-03", "05193105232747012"),
("2024-07-04", "05686740488180434"),
("2024-07-05", "01915686462589995"),
("2024-07-08", "04849050699005051"),
("2024-07-09", "04393133724269258"),
("2024-07-10", "06068293768762836"),
("2024-07-11", "07749047650223709"),
("2024-07-12", "03502238636990467"),
("2024-07-15", "05351366852524361"),
("2024-07-16", "03087073629143112"),
("2024-07-17", "07746229177467952"),
("2024-07-18", "03247446552737697"),
("2024-07-19", "04729809639371462"),
("2024-07-23", "04228862830845460"),
("2024-07-24", "07975104460940846"),
("2024-07-25", "01098723678305850"),
("2024-07-26", "00648852720622163"),
("2024-07-30", "08059816006850988"),
("2024-07-31", "05849201180718677"),
("2024-08-01", "08195041801157589"),
("2024-08-02", "09976868943320867"),
("2024-08-05", "05949456334746741"),
("2024-08-06", "05992629531640166"),
("2024-08-07", "08483979675745554"),
("2024-08-08", "02233651037822570"),
("2024-08-09", "06540058068430782"),
("2024-08-13", "08174150818117972"),
("2024-08-14", "03051790072936910"),
("2024-08-15", "06603858436338485"),
("2024-08-16", "05470890504200016"),
("2024-08-19", "09090646470703838"),
("2024-08-20", "02789076922841274"),
("2024-08-21", "00088150386748371"),
("2024-08-22", "02340062318350320"),
("2024-08-23", "02724585579768784"),
("2024-08-26", "06477869923368194"),
("2024-08-27", "00774849750693150"),
("2024-08-28", "09635369512197241"),
("2024-08-29", "02151571513594131"),
("2024-08-30", "05716066560190766"),
("2024-09-02", "07532278039686443"),
("2024-09-03", "03672831977136096"),
("2024-09-04", "08872362496644989"),
("2024-09-05", "08031207139902879"),
("2024-09-06", "02698805274466436"),
("2024-09-09", "05793993588241349"),
("2024-09-10", "02588516246670310"),
("2024-09-11", "04558158813904162"),
("2024-09-12", "03089379659185817"),
("2024-09-13", "05193034582243981"),
("2024-09-16", "00061208166275314"),
("2024-09-17", "04390024995426007"),
("2024-09-18", "09232357500407783"),
("2024-09-19", "09215951894178407"),
("2024-09-20", "07288284478946915"),
("2024-09-23", "04879780990799079"),
("2024-09-24", "01626324294041020"),
("2024-09-25", "07666069672625852"),
("2024-09-26", "00850689021370355"),
("2024-09-27", "08716009767641588"),
("2024-09-30", "03184756007928332"),
("2024-10-01", "06986769364816683"),
("2024-10-02", "03036283809574026"),
("2024-10-03", "05387330719217367"),
("2024-10-04", "09875790658852552"),
("2024-10-07", "03308542929042095"),
("2024-10-08", "03684806002828060"),
("2024-10-09", "00525062645659717"),
("2024-10-10", "06871616404075255"),
("2024-10-11", "08735600838861058"),
("2024-10-15", "02010382882280307"),
("2024-10-16", "01984807730270198"),
("2024-10-17", "03029212036350201"),
("2024-10-18", "07573686629278250"),
("2024-10-21", "03553810156267408"),
("2024-10-22", "01856502427473242"),
("2024-10-24", "02804518113196468"),
("2024-10-25", "02965650116524278"),
("2024-10-28", "09151311198440339"),
("2024-10-29", "04946322994911687"),
("2024-10-30", "03284674965512096"),
("2024-10-31", "02606199972520484"),
("2024-11-01", "05153248019851787"),
("2024-11-04", "05942210452359522"),
("2024-11-05", "07387936734742931"),
("2024-11-06", "09566077872433102"),
("2024-11-07", "07061953674579140"),
("2024-11-10", "00817031268772635"),
("2024-11-11", "06539487896304779"),
("2024-11-12", "06114668160878166"),
("2024-11-13", "04463951490094463"),
("2024-11-14", "03905370742022618"),
("2024-11-17", "09729906497710781"),
("2024-11-18", "03275931481260403"),
("2024-11-19", "05753842097071713"),
("2024-11-20", "01295422532158164"),
("2024-11-21", "04041245755264041"),
("2024-11-24", "01979945480407367"),
("2024-11-25", "07502224906337805"),
("2024-11-26", "05779829684941860"),
("2024-11-27", "06446230575437147"),
("2024-11-28", "06493790845746998"),
("2024-12-01", "03364690065965788"),
("2024-12-02", "02669807745125801"),
("2024-12-03", "09068342423358276"),
("2024-12-04", "01331206207757705"),
("2024-12-08", "05477383932453938"),
("2024-12-09", "08041228380418748"),
("2024-12-11", "04457335477105433"),
("2024-12-12", "04086832902481056"),
("2024-12-15", "05258554516064030"),
("2024-12-16", "07268033796446872"),
("2024-12-17", "04678957482868583"),
("2024-12-18", "04964077885000778"),
("2024-12-19", "04942655841341912"),
("2024-12-22", "05637634419006849"),
("2024-12-23", "09177346694261143"),
("2024-12-24", "00998347705063322"),
("2024-12-25", "01617597437967756"),
("2024-12-26", "03558492857202552"),
("2024-12-29", "08661675883420322"),
("2024-12-30", "00697403791886764"),
("2026-01-05", "00235730663960538"),
("2026-01-06", "01788218409967530"),
("2026-01-07", "00328911659168207"),
("2026-01-08", "04240978544386022"),
("2026-01-09", "07818640478180949"),
("2026-01-12", "08273327709002089"),
("2026-01-13", "00686576328923090"),
("2026-01-14", "07141926294643000"),
("2026-01-15", "08842007018883909"),
("2026-01-16", "07366773881426021"),
("2026-01-19", "04181448431712060"),
("2026-01-20", "04929836391713717"),
("2026-01-21", "06326370026895619"),
("2026-01-22", "04286943888326492"),
("2026-01-23", "01248640068043975"),
("2026-01-26", "02217271284550732"),
    # ‡∏á‡∏ß‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 2026-01-17
]
# ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏£‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏ú‡∏°‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏±‡∏á ‡πÉ‡∏´‡πâ Copy raw_data ‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡∏ó‡∏±‡∏ö‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö

position_map = {
    0: 'a', 1: 'b', 2: 'c', 3: 'd', 4: 'e', 5: 'f', 6: 'g', 7: 'h', 8: 'i',
    9: 'j', 10: 'k', 11: 'l', 12: 'm', 13: 'n', 14: 'o', 15: 'p', 16: 'q'
}

char_to_index = {v: k for k, v in position_map.items() if k != 0}

pair_to_indices = {
    'bc': [1, 2], 'de': [3, 4], 'fg': [5, 6], 'hi': [7, 8],
    'jk': [9, 10], 'lm': [11, 12], 'no': [13, 14], 'pq': [15, 16]
}

pos_desc = {
    'b': '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö-‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πâ‡∏≤', 'c': '‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢-‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πâ‡∏≤',
    'd': '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö-‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏ä‡πâ‡∏≤', 'e': '‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢-‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏ä‡πâ‡∏≤',
    'f': '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö-‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á', 'g': '‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢-‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á',
    'h': '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö-‡∏õ‡∏¥‡∏î‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á', 'i': '‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢-‡∏õ‡∏¥‡∏î‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á',
    'j': '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö-‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡πà‡∏≤‡∏¢', 'k': '‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢-‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡πà‡∏≤‡∏¢',
    'l': '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö-‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡πà‡∏≤‡∏á‡∏ö‡πà‡∏≤‡∏¢', 'm': '‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢-‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡πà‡∏≤‡∏á‡∏ö‡πà‡∏≤‡∏¢',
    'n': '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö-‡∏õ‡∏¥‡∏î‡πÄ‡∏¢‡πá‡∏ô', 'o': '‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢-‡∏õ‡∏¥‡∏î‡πÄ‡∏¢‡πá‡∏ô',
    'p': '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö-‡∏õ‡∏¥‡∏î‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏¢‡πá‡∏ô', 'q': '‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢-‡∏õ‡∏¥‡∏î‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏¢‡πá‡∏ô',
    'bc': '‡∏ß‡∏¥‡πà‡∏á‡∏™‡∏¥‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏ô-‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πâ‡∏≤', 'de': '‡∏ß‡∏¥‡πà‡∏á‡∏™‡∏¥‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏á-‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πâ‡∏≤',
    'fg': '‡∏ß‡∏¥‡πà‡∏á‡∏™‡∏¥‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏ô-‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á', 'hi': '‡∏ß‡∏¥‡πà‡∏á‡∏™‡∏¥‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏á-‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á',
    'jk': '‡∏ß‡∏¥‡πà‡∏á‡∏™‡∏¥‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏ô-‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡πà‡∏≤‡∏¢', 'lm': '‡∏ß‡∏¥‡πà‡∏á‡∏™‡∏¥‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏á-‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡πà‡∏≤‡∏¢',
    'no': '‡∏ß‡∏¥‡πà‡∏á‡∏™‡∏¥‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏ô-‡∏õ‡∏¥‡∏î‡πÄ‡∏¢‡πá‡∏ô', 'pq': '‡∏ß‡∏¥‡πà‡∏á‡∏™‡∏¥‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏á-‡∏õ‡∏¥‡∏î‡πÄ‡∏¢‡πá‡∏ô'
}

# ==========================================
# 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (Logic ‡πÄ‡∏î‡∏¥‡∏°)
# ==========================================

def get_digit(data_row, index):
    return int(data_row[1][index])

def calculate_prediction(draw, indices, k):
    total = sum(get_digit(draw, idx) for idx in indices)
    return (total + k) % 10

# ‡πÉ‡∏ä‡πâ cache ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏°‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏ô‡πâ‡∏≠‡∏¢‡πÜ
@st.cache_data
def find_formulas(mode, target_indices, history_data, lookback_rounds, max_formulas, min_accuracy):
    results = []
    total_positions = 17

    if len(history_data) < lookback_rounds + 1:
        return []

    test_data = history_data[-(lookback_rounds+1):]
    total_test_rounds = len(test_data) - 1
    max_misses = int(total_test_rounds * (1 - (min_accuracy / 100)))

    # ‡∏™‡∏π‡∏ï‡∏£ 2 ‡∏ï‡∏±‡∏ß
    for x in range(1, total_positions):
        for y in range(x, total_positions):
            for k in range(10):
                miss_count = 0
                indices = [x, y]
                for i in range(total_test_rounds):
                    prediction = calculate_prediction(test_data[i], indices, k)
                    if mode == 'kill':
                        actual = get_digit(test_data[i+1], target_indices[0])
                        if prediction == actual: miss_count += 1
                    elif mode == 'run':
                        actuals = [get_digit(test_data[i+1], idx) for idx in target_indices]
                        if prediction not in actuals: miss_count += 1
                    if miss_count > max_misses: break
                
                if miss_count <= max_misses:
                    accuracy = ((total_test_rounds - miss_count) / total_test_rounds) * 100
                    results.append({'indices': indices, 'k': k, 'misses': miss_count, 'accuracy': accuracy, 'description': f"{position_map[x]} + {position_map[y]} + {k}"})

    # ‡∏™‡∏π‡∏ï‡∏£ 3 ‡∏ï‡∏±‡∏ß
    for x in range(1, total_positions):
        for y in range(x, total_positions):
            for z in range(y, total_positions):
                for k in range(10):
                    miss_count = 0
                    indices = [x, y, z]
                    for i in range(total_test_rounds):
                        prediction = calculate_prediction(test_data[i], indices, k)
                        if mode == 'kill':
                            actual = get_digit(test_data[i+1], target_indices[0])
                            if prediction == actual: miss_count += 1
                        elif mode == 'run':
                            actuals = [get_digit(test_data[i+1], idx) for idx in target_indices]
                            if prediction not in actuals: miss_count += 1
                        if miss_count > max_misses: break
                    
                    if miss_count <= max_misses:
                        accuracy = ((total_test_rounds - miss_count) / total_test_rounds) * 100
                        results.append({'indices': indices, 'k': k, 'misses': miss_count, 'accuracy': accuracy, 'description': f"{position_map[x]} + {position_map[y]} + {position_map[z]} + {k}"})

    results.sort(key=lambda item: item['accuracy'], reverse=True)
    return results[:max_formulas]

# ==========================================
# 3. ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (UI)
# ==========================================
st.title("üí∞ Supersootr Analyzer V2")
st.markdown("‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏•‡∏Ç **‡∏î‡∏±‡∏ö** ‡πÅ‡∏•‡∏∞ **‡∏ß‡∏¥‡πà‡∏á** (Multi-Mode)")

# Sidebar ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
with st.sidebar:
    st.header("‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì")
    lookback = st.slider("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (Lookback)", 3, 200, 70)
    formula_limit = st.slider("‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏π‡∏ï‡∏£ (Max Formulas)", 100, 3000, 1000)
    
    st.markdown("---")
    st.info(f"‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: {raw_data[-1][0]}")

# ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏Å
mode_choice = st.radio("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î", ["1. ‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏î‡∏±‡∏ö (Killing)", "2. ‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ß‡∏¥‡πà‡∏á (Running)"], horizontal=True)
target_mode = 'kill' if "Killing" in mode_choice else 'run'

# ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Dropdown)
if target_mode == 'kill':
    min_acc_default = 90.0
    options = list(char_to_index.keys())
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á label ‡∏™‡∏ß‡∏¢‡πÜ ‡πÉ‡∏´‡πâ Dropdown
    format_func = lambda x: f"{x} - {pos_desc.get(x, '')}"
    selected_pos = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏î‡∏±‡∏ö", options, format_func=format_func, index=0) # Default 'n'
    target_indices = [char_to_index[selected_pos]]
    target_name = f"‡πÄ‡∏•‡∏Ç‡∏î‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å: {selected_pos.upper()}"
else:
    min_acc_default = 70.0
    options = list(pair_to_indices.keys())
    format_func = lambda x: f"{x} - {pos_desc.get(x, '')}"
    selected_pos = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏π‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ß‡∏¥‡πà‡∏á", options, format_func=format_func, index=0) # Default 'no'
    target_indices = pair_to_indices[selected_pos]
    target_name = f"‡πÄ‡∏•‡∏Ç‡∏ß‡∏¥‡πà‡∏á‡∏Ñ‡∏π‡πà: {selected_pos.upper()}"

min_accuracy = st.number_input("‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (%)", min_value=50.0, max_value=100.0, value=min_acc_default, step=0.5)

# ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
if st.button("üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏π‡∏ï‡∏£", type="primary"):
    with st.spinner('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏±‡∏ö‡∏û‡∏±‡∏ô... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...'):
        formulas = find_formulas(target_mode, target_indices, raw_data, lookback, formula_limit, min_accuracy)
    
    if not formulas:
        st.error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÄ‡∏•‡∏¢! ‡∏•‡∏≠‡∏á‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏•‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á")
    else:
        st.success(f"‡∏û‡∏ö‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏î‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: {len(formulas)} ‡∏™‡∏π‡∏ï‡∏£")
        
        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏á‡∏ß‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        last_draw = raw_data[-1]
        next_numbers = []
        
        # ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏π‡∏ï‡∏£
        with st.expander("‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ï‡∏£ (Top 10)"):
            top_formulas = []
            for f in formulas:
                pred_num = calculate_prediction(last_draw, f['indices'], f['k'])
                next_numbers.append(pred_num)
                top_formulas.append({
                    "‡∏™‡∏π‡∏ï‡∏£": f['description'],
                    "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥": f"{f['accuracy']:.2f}%",
                    "‡∏ú‡∏¥‡∏î (‡∏á‡∏ß‡∏î)": f['misses'],
                    "‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏á‡∏ß‡∏î‡∏ô‡∏µ‡πâ": pred_num
                })
            st.table(pd.DataFrame(top_formulas[:10]))

        # ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•
        st.markdown("---")
        st.header(f"üèÜ ‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå: {target_name}")
        
        stats = Counter(next_numbers)
        # ‡πÄ‡∏ï‡∏¥‡∏° 0 ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 0-9 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏ß‡∏¢
        for d in range(10):
            if d not in stats: stats[d] = 0
            
        df_stats = pd.DataFrame.from_dict(stats, orient='index', columns=['Count'])
        df_stats.index.name = 'Number'
        df_stats = df_stats.sort_values(by='Count', ascending=False)
        
        # ‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πà‡∏ô‡∏™‡∏∏‡∏î
        best_num = df_stats.index[0]
        max_score = df_stats.iloc[0]['Count']
        percent = (max_score / len(formulas)) * 100
        
        col1, col2 = st.columns([1, 2])
        
        with col1:
            st.metric(label="‡∏ü‡∏±‡∏ô‡∏ò‡∏á‡πÄ‡∏•‡∏Ç", value=str(best_num), delta=f"{percent:.1f}% Confidence")
            if target_mode == 'kill':
                st.caption("‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞ **‡πÑ‡∏°‡πà‡∏°‡∏≤**")
            else:
                st.caption("‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞ **‡∏°‡∏≤**")
                
        with col2:
            st.bar_chart(df_stats)


        st.dataframe(df_stats.T)







